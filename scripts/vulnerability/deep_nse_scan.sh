#!/bin/sh

# Source shared utility functions
. "$(dirname "$0")/../common/utils.sh"

echo "=== Deep Port Scan with Safe NSE Scripts ==="
echo

RESULTS_DIR="${NETUTIL_WORKDIR:-$HOME}/vulnerability"
mkdir -p "$RESULTS_DIR"

TIMESTAMP=$(date +%Y%m%d_%H%M%S)

targets=$(select_target)
if [ -z "$targets" ]; then
    error_message "No target selected"
    exit 1
fi

success_message "Selected target: $targets"

echo "Scan intensity:"
echo "1. Quick scan (Top 1000 ports)"
echo "2. Comprehensive scan (All 65535 ports)"
echo "3. Custom port range"

read -p "Select scan intensity (1-3): " intensity

case $intensity in
    1)
        ports="--top-ports 1000"
        scan_type="quick"
        ;;
    2)
        ports="-p-"
        scan_type="comprehensive"
        ;;
    3)
        read -p "Enter port range (e.g., 1-1000 or 80,443,8080): " custom_ports
        ports="-p $custom_ports"
        scan_type="custom"
        ;;
    *)
        warning_message "Invalid option, using quick scan"
        ports="--top-ports 1000"
        scan_type="quick"
        ;;
esac

SCAN_RESULTS="$RESULTS_DIR/deep_scan_${scan_type}_${TIMESTAMP}.txt"
NSE_RESULTS="$RESULTS_DIR/nse_safe_scan_${TIMESTAMP}.txt"
REPORT_FILE="$RESULTS_DIR/vulnerability_report_${TIMESTAMP}.txt"

echo "Starting deep port scan with safe NSE vulnerability detection..."
echo "Results will be saved to: $RESULTS_DIR"
echo

echo "=== Deep Port Scan with Safe NSE Script Report ===" > "$REPORT_FILE"
echo "Scan time: $(date)" >> "$REPORT_FILE"
echo "Targets: $targets" >> "$REPORT_FILE"
echo "Scan type: $scan_type" >> "$REPORT_FILE"
echo "Ports: $ports" >> "$REPORT_FILE"
echo "Note: Only safe, non-intrusive NSE scripts used" >> "$REPORT_FILE"
echo >> "$REPORT_FILE"

echo "Phase 1: Deep port scan with service detection..."
echo "Command: nmap -sS -sV -O $ports $targets"

nmap -sS -sV -O $ports $targets -oN "$SCAN_RESULTS"

echo "Phase 2: Safe NSE vulnerability scanning..."
echo "Running safe NSE vulnerability scripts (no brute force)..."

nmap --script "vuln and not brute and not dos" $targets -oN "$NSE_RESULTS"

echo "Phase 3: Service enumeration with safe scripts..."

echo "--- SERVICE DETECTION ---" >> "$REPORT_FILE"
echo >> "$REPORT_FILE"
grep -A 50 "PORT.*STATE.*SERVICE" "$SCAN_RESULTS" >> "$REPORT_FILE"
echo >> "$REPORT_FILE"

echo "--- OS DETECTION ---" >> "$REPORT_FILE"
echo >> "$REPORT_FILE"
grep -A 10 "OS details" "$SCAN_RESULTS" >> "$REPORT_FILE"
echo >> "$REPORT_FILE"

echo "--- SAFE VULNERABILITY SCAN RESULTS ---" >> "$REPORT_FILE"
echo >> "$REPORT_FILE"
cat "$NSE_RESULTS" >> "$REPORT_FILE"
echo >> "$REPORT_FILE"

echo "Phase 4: Safe targeted NSE scripts based on detected services..."

detected_services=$(grep "open" "$SCAN_RESULTS" | grep -E "http|https|ssh|ftp|smb|mysql|postgres|mssql|vnc|rdp" | head -20)

if echo "$detected_services" | grep -q "80/tcp\|443/tcp\|8080/tcp"; then
    echo "Running safe HTTP enumeration scripts..."
    nmap --script "http-enum,http-headers,http-methods,http-title,http-server-header" $targets >> "$REPORT_FILE"
fi

if echo "$detected_services" | grep -q "22/tcp.*ssh"; then
    echo "Running safe SSH enumeration scripts..."
    nmap --script "ssh-auth-methods,ssh-hostkey,ssh2-enum-algos" $targets >> "$REPORT_FILE"
fi

if echo "$detected_services" | grep -q "445/tcp\|139/tcp"; then
    echo "Running safe SMB enumeration scripts..."
    nmap --script "smb-os-discovery,smb-protocols,smb-security-mode,smb-enum-shares" $targets >> "$REPORT_FILE"
fi

if echo "$detected_services" | grep -q "3306/tcp.*mysql"; then
    echo "Running safe MySQL enumeration scripts..."
    nmap --script "mysql-info,mysql-enum" $targets >> "$REPORT_FILE"
fi

if echo "$detected_services" | grep -q "1433/tcp.*mssql"; then
    echo "Running safe MSSQL enumeration scripts..."
    nmap --script "ms-sql-info,ms-sql-config" $targets >> "$REPORT_FILE"
fi

if echo "$detected_services" | grep -q "21/tcp.*ftp"; then
    echo "Running safe FTP enumeration scripts..."
    nmap --script "ftp-anon,ftp-bounce,ftp-syst" $targets >> "$REPORT_FILE"
fi

echo "Phase 5: SSL/TLS security assessment..."
if echo "$detected_services" | grep -q "443/tcp\|ssl\|tls"; then
    echo "Running SSL/TLS security checks..."
    nmap --script "ssl-cert,ssl-enum-ciphers,ssl-heartbleed,ssl-poodle,ssl-ccs-injection" $targets >> "$REPORT_FILE"
fi

echo "Phase 6: Vulnerability summary and analysis..."

echo "--- VULNERABILITY SUMMARY ---" >> "$REPORT_FILE"
echo >> "$REPORT_FILE"

critical_vulns=$(grep -i "CRITICAL\|HIGH" "$NSE_RESULTS" | wc -l)
medium_vulns=$(grep -i "MEDIUM" "$NSE_RESULTS" | wc -l)
low_vulns=$(grep -i "LOW" "$NSE_RESULTS" | wc -l)

echo "Critical/High vulnerabilities: $critical_vulns" >> "$REPORT_FILE"
echo "Medium vulnerabilities: $medium_vulns" >> "$REPORT_FILE"
echo "Low vulnerabilities: $low_vulns" >> "$REPORT_FILE"
echo >> "$REPORT_FILE"

if [ "$critical_vulns" -gt 0 ]; then
    echo "CRITICAL/HIGH VULNERABILITIES DETECTED:" >> "$REPORT_FILE"
    grep -i -A 5 "CRITICAL\|HIGH" "$NSE_RESULTS" >> "$REPORT_FILE"
    echo >> "$REPORT_FILE"
fi

echo "--- COMMON VULNERABILITIES FOUND ---" >> "$REPORT_FILE"
echo >> "$REPORT_FILE"

if grep -q "ssl-poodle\|ssl-heartbleed\|ssl-ccs-injection" "$NSE_RESULTS"; then
    echo "SSL/TLS vulnerabilities detected" >> "$REPORT_FILE"
fi

if grep -q "smb-vuln-ms17-010\|smb-vuln-ms08-067" "$NSE_RESULTS"; then
    echo "SMB vulnerabilities detected (EternalBlue, MS08-067)" >> "$REPORT_FILE"
fi

if grep -q "http-vuln" "$NSE_RESULTS"; then
    echo "Web application vulnerabilities detected" >> "$REPORT_FILE"
fi

echo "--- SERVICE SECURITY ASSESSMENT ---" >> "$REPORT_FILE"
echo >> "$REPORT_FILE"

if echo "$detected_services" | grep -q "23/tcp.*telnet"; then
    echo "WARNING: Telnet service detected - unencrypted remote access" >> "$REPORT_FILE"
fi

if echo "$detected_services" | grep -q "21/tcp.*ftp"; then
    echo "INFO: FTP service detected - check for anonymous access" >> "$REPORT_FILE"
fi

if echo "$detected_services" | grep -q "80/tcp.*http"; then
    echo "INFO: HTTP service detected - consider HTTPS redirect" >> "$REPORT_FILE"
fi

echo "--- RECOMMENDATIONS ---" >> "$REPORT_FILE"
echo >> "$REPORT_FILE"
echo "1. Address critical and high vulnerabilities immediately" >> "$REPORT_FILE"
echo "2. Update and patch all identified services" >> "$REPORT_FILE"
echo "3. Disable unnecessary services" >> "$REPORT_FILE"
echo "4. Implement strong authentication mechanisms" >> "$REPORT_FILE"
echo "5. Use encrypted protocols (SSH instead of Telnet, HTTPS instead of HTTP)" >> "$REPORT_FILE"
echo "6. Regular vulnerability scanning and security assessments" >> "$REPORT_FILE"
echo "7. Implement network segmentation and access controls" >> "$REPORT_FILE"

echo "Safe vulnerability scan complete!"
echo
echo "Files created:"
echo "  Port scan results: $SCAN_RESULTS"
echo "  NSE safe scan results: $NSE_RESULTS"
echo "  Comprehensive report: $REPORT_FILE"
echo
echo "Summary:"
echo "  Critical/High vulnerabilities: $critical_vulns"
echo "  Medium vulnerabilities: $medium_vulns"
echo "  Low vulnerabilities: $low_vulns"

if [ "$critical_vulns" -gt 0 ]; then
    echo
    echo "⚠️  CRITICAL VULNERABILITIES DETECTED!"
    echo "Review the full report immediately."
fi

echo
echo "--- VULNERABILITY REPORT ---"
cat "$REPORT_FILE"